{{!-- frontendstuff/views/map.handlebars --}}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>
    #map {
        height: 600px;
        width: 100%;
        margin-top: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .popup-form {
        min-width: 250px;
    }

    .popup-form input,
    .popup-form textarea {
        width: 100%;
        margin-bottom: 8px;
        padding: 5px;
        box-sizing: border-box;
    }

    .legend {
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }
</style>

<h1>NYC Danger Map</h1>
<p>View community reports and official shooting incident data. Click anywhere within NYC to report a new incident.</p>

<div id="map"></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize map centered on NYC
        // Bounds are a bit broader so that users can see the full post details
        const bounds = [
            [40.300, -74.300], // Southwest coordinates
            [41.100, -73.600]  // Northeast coordinates
        ];

        const map = L.map('map', {
            maxBounds: bounds,
            maxBoundsViscosity: 1.0
        }).setView([40.7128, -74.0060], 11);

        L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '© Google Maps'
        }).addTo(map);

        // Define custom marker icons
        const blueIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // Fetch and display internal posts from database (Blue markers)
        // Using the API endpoint from server/routes/posts.js
        fetch('/posts')
            .then(response => {
                if (!response.ok) throw new Error("Failed to fetch internal posts");
                return response.json();
            })
            .then(posts => {
                posts.forEach(post => {
                    if (post.location && post.location.latitude && post.location.longitude) {
                        const sensitiveWarning = post.sensitive ? '<p style="color:red;font-weight:bold;">⚠️ Sensitive Content</p>' : '';
                        const popupContent = `
                            <div class="post-preview">
                                <h3>${post.title}</h3>
                                ${sensitiveWarning}
                                <p>${post.body || ''}</p>
                                <p><small>Date: ${new Date(post.date).toLocaleDateString()}</small></p>
                                <a href="/posts/${post._id}">View Details</a>
                            </div>
                        `;
                        L.marker([post.location.latitude, post.location.longitude], { icon: blueIcon })
                            .bindPopup(popupContent)
                            .addTo(map);
                    }
                });
            })
            .catch(err => console.error("Error loading posts:", err));

        // Fetch and display NYC Official Shooting Data (Red markers)
        // Using SODA API endpoint to get JSON data directly
        const nycApiUrl = "https://data.cityofnewyork.us/resource/833y-fsy8.json?$limit=1000&$order=occur_date DESC"; // historical data is limited to 1000

        fetch(nycApiUrl)
            .then(response => response.json())
            .then(data => {
                data.forEach(incident => {
                    if (incident.latitude && incident.longitude) {
                        const popupContent = `
                            <div class="incident-preview">
                                <h3 style="color: #d32f2f;">NYC Shooting Incident</h3>
                                <p><strong>Date:</strong> ${incident.occur_date}</p>
                                <p><strong>Time:</strong> ${incident.occur_time}</p>
                                <p><strong>Boro:</strong> ${incident.boro}</p>
                                <p><strong>Location:</strong> ${incident.location_desc || 'Street'}</p>
                                <p><small>Source: NYC Open Data</small></p>
                            </div>
                        `;
                        L.marker([incident.latitude, incident.longitude], { icon: redIcon })
                            .bindPopup(popupContent)
                            .addTo(map);
                    }
                });
            })
            .catch(err => console.error("Error loading NYC data:", err));

        // Click event to create a new Post
        map.on('click', function (e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            // Check bounds (Double check client side)
            if (lat < 40.496 || lat > 40.916 || lng < -74.258 || lng > -73.699) {
                alert("Location is outside of NYC.");
                return;
            }

            const popupContent = `
                <div class="popup-form">
                    <h3>Report Incident Here</h3>
                    <form action="/posts" method="POST">
                        <input type="hidden" name="latitude" value="${lat}">
                        <input type="hidden" name="longitude" value="${lng}">
                        
                        <label>Title:</label>
                        <input type="text" name="title" required placeholder="Short title...">
                        
                        <label>Description:</label>
                        <textarea name="body" rows="3" placeholder="What happened?"></textarea>
                        
                        <label>Photo URL (Optional):</label>
                        <input type="text" name="photo" placeholder="http://...">
                        
                        <label>
                            <input type="checkbox" name="sensitive"> 
                            Contains Sensitive Content?
                        </label>
                        
                        <button type="submit" class="button-primary" style="width:100%; margin-top:5px;">Create Post</button>
                    </form>
                </div>
            `;

            L.popup()
                .setLatLng(e.latlng)
                .setContent(popupContent)
                .openOn(map);
        });

        // Add Legend
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML += '<i style="background: #2b82cb"></i> Community Posts<br>';
            div.innerHTML += '<i style="background: #cb2b3e"></i> NYC Shooting Data<br>';
            return div;
        };
        legend.addTo(map);
    });
</script>