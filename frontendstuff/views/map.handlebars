{{!-- frontendstuff/views/map.handlebars --}}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- plugin for heatmap (leaflet)-->
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<style>
    #map {
        height: 600px;
        width: 100%;
        margin-top: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .popup-form {
        min-width: 250px;
    }

    .popup-form input,
    .popup-form textarea {
        width: 100%;
        margin-bottom: 8px;
        padding: 5px;
        box-sizing: border-box;
    }

    .legend {
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }

    /* Map Controls - Floating Sidebar Style */
    .map-controls {
        position: absolute;
        top: 140px;
        /* Moved down to avoid overlap */
        left: 10px;
        z-index: 1000;
        /* Above map */
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        /* Stack vertically for better layout */
        gap: 10px;
        max-width: 250px;
    }

    .map-controls label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .slider-container {
        display: flex;
        flex-direction: column;
        gap: 5px;
        padding: 5px 0;
        border-top: 1px solid #eee;
    }

    .slider-container input[type="range"] {
        width: 100%;
    }

    /* Heatmap gradient legend */
    .heatmap-gradient {
        width: 120px;
        height: 12px;
        background: linear-gradient(to right, #0000ff, #00ffff, #00ff00, #ffff00, #ff0000);
        border-radius: 3px;
        margin: 5px 0;
    }

    .gradient-labels {
        display: flex;
        justify-content: space-between;
        font-size: 0.75em;
        color: #666;
    }
</style>

<div id="map-container">
    <div id="map"></div>

    <!-- Map Controls Moved Inside Container -->
    <div class="map-controls">
        <h4 style="margin: 0 0 10px 0; font-size: 1rem;">Map Layers</h4>
        <label>
            <input type="checkbox" id="toggleMarkers" checked>
            View Crime Markers
        </label>
        <label>
            <input type="checkbox" id="toggleCommunity" checked>
            Data: Community
        </label>
        <label>
            <input type="checkbox" id="toggleNYC" checked>
            Data: NYC Official
        </label>

        <hr style="width: 100%; border: 0; border-top: 1px solid #eee; margin: 5px 0;">

        <h4 style="margin: 0 0 10px 0; font-size: 1rem;">Heatmap Settings</h4>
        <label>
            <input type="checkbox" id="toggleHeatmap">
            Display Heatmap
        </label>
        <div class="slider-container">
            <span>Radius: <span id="radiusValue">25</span></span>
            <input type="range" id="heatRadius" min="10" max="60" value="25">
        </div>
        <div class="slider-container">
            <span>Intensity: <span id="intensityValue">0.5</span></span>
            <input type="range" id="heatIntensity" min="0.1" max="1.5" step="0.1" value="0.5">
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize map centered on NYC
        // Bounds are a bit broader so that users can see the full post details
        const bounds = [
            [40.300, -74.300], // Southwest coordinates
            [41.100, -73.600]  // Northeast coordinates
        ];

        window.map = L.map('map', {
            maxBounds: bounds,
            maxBoundsViscosity: 1.0
        }).setView([40.7128, -74.0060], 11);
        const map = window.map;

        map.invalidateSize();

        L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: 'Â© Google Maps'
        }).addTo(map);

        // Define custom marker icons
        const blueIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [18, 30],
            iconAnchor: [9, 30],
            popupAnchor: [1, -25],
            shadowSize: [30, 30]
        });

        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [18, 30],
            iconAnchor: [9, 30],
            popupAnchor: [1, -25],
            shadowSize: [30, 30]
        });

        // 3. Layer groups for markers
        const communityMarkers = L.layerGroup().addTo(map);
        const nycMarkers = L.layerGroup().addTo(map);

        // 4. Heatmap data arrays
        let communityHeatData = [];
        let nycHeatData = [];
        let heatLayer = null;

        let heatConfig = {
            radius: 25,
            blur: 35,
            maxZoom: 12,
            max: 0.5,
            minOpacity: 0.4,
            gradient: {
                0.0: 'blue',
                0.25: 'cyan',
                0.5: 'lime',
                0.75: 'yellow',
                1.0: 'red'
            }
        };

        // Function to update heatmap
        function updateHeatmap() {
            const showCommunity = document.getElementById('toggleCommunity').checked;
            const showNYC = document.getElementById('toggleNYC').checked;
            const showHeatmap = document.getElementById('toggleHeatmap').checked;

            // Remove existing heatmap
            if (heatLayer) {
                map.removeLayer(heatLayer);
                heatLayer = null;
            }

            if (!showHeatmap) return;

            // Combine heat data based on toggles
            let combinedData = [];
            if (showCommunity) {
                combinedData = combinedData.concat(communityHeatData);
            }
            if (showNYC) {
                combinedData = combinedData.concat(nycHeatData);
            }

            if (combinedData.length > 0) {
                heatLayer = L.heatLayer(combinedData, heatConfig).addTo(map);
            }
        }

        // 3. Fetch and display internal posts from database (Blue markers)
        // Using the API endpoint from server/routes/posts.js
        fetch('/api/posts')
            .then(response => {
                if (!response.ok) throw new Error("Failed to fetch internal posts");
                return response.json();
            })
            .then(posts => {
                posts.forEach(post => {
                    if (post.location && post.location.latitude && post.location.longitude) {
                        const lat = post.location.latitude;
                        const lng = post.location.longitude;
                        communityHeatData.push([lat, lng, 0.5]);

                        const postId = post._id;
                        const marker = L.marker([post.location.latitude, post.location.longitude], { icon: blueIcon });

                        const loadCommentsAndUpdatePopup = function () {
                            fetch(`/api/posts/${postId}/comments`)
                                .then(response => response.json())
                                .then(comments => {
                                    const currentUserId = '{{user._id}}';
                                    let commentsHtml = '';
                                    if (comments.length > 0) {
                                        commentsHtml = '<div style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px;"><strong>Comments:</strong><ul style="margin:5px 0; padding-left:20px; max-height:100px; overflow-y:auto; font-size:12px;">';
                                        comments.forEach(comment => {
                                            const isOwner = comment.user === currentUserId;
                                            const deleteBtn = isOwner ? `<button onclick="deleteMapComment('${postId}', '${comment._id}', '${postId}')" style="margin-left:5px; padding:2px 5px; font-size:10px; background:#dc3545; color:white; border:none; cursor:pointer; border-radius:3px;">Delete</button>` : '';
                                            commentsHtml += `<li style="margin-bottom:3px;" id="comment-${comment._id}">${comment.text} <small>(Score: ${comment.score})</small> ${deleteBtn}</li>`;
                                        });
                                        commentsHtml += '</ul></div>';
                                    } else {
                                        commentsHtml = '<div style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px;"><p style="font-style:italic; color:#666; font-size:12px;">No comments yet</p></div>';
                                    }

                                    const sensitiveWarning = post.sensitive ? '<p style="color:red;font-weight:bold; font-size:12px;">Sensitive Content</p>' : '';
                                    const commentForm = `
                                        <div style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px;">
                                            <strong style="font-size:12px;">Add Comment:</strong>
                                            <form id="comment-form-${postId}" style="margin-top:5px;">
                                                <textarea name="text" rows="2" placeholder="Write your comment..." required style="width:100%; padding:5px; box-sizing:border-box; font-size:11px;"></textarea>
                                                <input type="number" name="score" min="0" max="5" value="3" required style="width:100%; padding:5px; margin-top:5px; box-sizing:border-box; font-size:11px;" placeholder="Score (0-5)">
                                                <button type="submit" style="width:100%; margin-top:5px; padding:5px; background:#2b82cb; color:white; border:none; cursor:pointer; font-size:11px;">Post Comment</button>
                                            </form>
                                        </div>
                                    `;

                                    const fullContent = `
                                        <div class="post-preview" style="max-width:300px;">
                                            <h3 style="margin:0 0 10px 0; font-size:16px;">${post.title}</h3>
                                            ${sensitiveWarning}
                                            <p style="margin:5px 0; font-size:13px;">${post.body || ''}</p>
                                            <p style="margin:5px 0; font-size:11px; color:#666;"><small>Date: ${new Date(post.date).toLocaleDateString()}</small></p>
                                            ${commentsHtml}
                                            ${commentForm}
                                            <a href="/posts/${postId}" style="display:block; margin-top:10px; text-align:center; font-size:12px;">View Full Details</a>
                                        </div>
                                    `;

                                    marker.setPopupContent(fullContent);

                                    setTimeout(() => {
                                        const form = document.getElementById(`comment-form-${postId}`);
                                        if (form) {
                                            form.addEventListener('submit', function (e) {
                                                e.preventDefault();
                                                const formData = new FormData(e.target);
                                                const text = formData.get('text');
                                                const scoreStr = formData.get('score');
                                                const score = parseInt(scoreStr);

                                                if (!text || text.trim().length === 0) {
                                                    alert('Please enter a comment');
                                                    return;
                                                }

                                                if (isNaN(score) || score < 0 || score > 5) {
                                                    alert('Please enter a valid score between 0 and 5');
                                                    return;
                                                }

                                                const commentUrl = `/api/posts/${postId}/comments`;
                                                console.log('Posting comment to:', commentUrl);
                                                console.log('Comment data:', { text: text.trim(), score: score });

                                                fetch(commentUrl, {
                                                    method: 'POST',
                                                    headers: {
                                                        'Content-Type': 'application/json'
                                                    },
                                                    credentials: 'include',
                                                    body: JSON.stringify({
                                                        text: text.trim(),
                                                        score: score
                                                    })
                                                })
                                                    .then(response => {
                                                        console.log('Comment response status:', response.status);
                                                        console.log('Comment response URL:', response.url);
                                                        console.log('Comment response headers:', response.headers.get('content-type'));

                                                        if (response.ok) {
                                                            return response.json().then(data => {
                                                                loadCommentsAndUpdatePopup();
                                                            });
                                                        } else {
                                                            const contentType = response.headers.get('content-type');
                                                            if (contentType && contentType.includes('application/json')) {
                                                                return response.json().then(data => {
                                                                    alert('Error: ' + (data.error || 'Failed to post comment. Please make sure you are logged in.'));
                                                                }).catch(() => {
                                                                    alert('Error: Failed to post comment. Please make sure you are logged in.');
                                                                });
                                                            } else {
                                                                return response.text().then(text => {
                                                                    console.error('Non-JSON response:', text.substring(0, 200));
                                                                    alert('Error: Server returned non-JSON response. Status: ' + response.status + '. Please check console for details.');
                                                                });
                                                            }
                                                        }
                                                    })
                                                    .catch(err => {
                                                        alert('Error posting comment: ' + err.message);
                                                        console.error('Comment error:', err);
                                                    });
                                            });
                                        }
                                    }, 100);
                                })
                                .catch(err => {
                                    console.error("Error loading comments:", err);
                                    const errorContent = `
                                        <div class="post-preview">
                                            <h3>${post.title}</h3>
                                            ${sensitiveWarning}
                                            <p>${post.body || ''}</p>
                                            <p><small>Date: ${new Date(post.date).toLocaleDateString()}</small></p>
                                            <p style="color:red; font-size:12px;">Error loading comments</p>
                                            <a href="/posts/${postId}">View Details</a>
                                        </div>
                                    `;
                                    marker.setPopupContent(errorContent);
                                });
                        };

                        marker.on('popupopen', function () {
                            loadCommentsAndUpdatePopup();
                        });

                        const sensitiveWarning = post.sensitive ? '<p style="color:red;font-weight:bold; font-size:12px;">Sensitive Content</p>' : '';
                        const initialContent = `
                            <div class="post-preview" style="max-width:300px;">
                                <h3 style="margin:0 0 10px 0; font-size:16px;">${post.title}</h3>
                                ${sensitiveWarning}
                                <p style="margin:5px 0; font-size:13px;">${post.body || ''}</p>
                                <p style="margin:5px 0; font-size:11px; color:#666;"><small>Date: ${new Date(post.date).toLocaleDateString()}</small></p>
                                <p style="font-style:italic; color:#666; font-size:12px; margin-top:10px;">Loading comments...</p>
                                <a href="/posts/${postId}" style="display:block; margin-top:10px; text-align:center; font-size:12px;">View Details</a>
                            </div>
                        `;

                        marker.bindPopup(initialContent, { maxWidth: 350 }).addTo(communityMarkers);
                    }
                });
                updateHeatmap();
            })
            .catch(err => console.error("Error loading posts:", err));

        // Fetch and display NYC Official Shooting Data (Red markers)
        // Using SODA API endpoint to get JSON data directly
        const nycApiUrl = "https://data.cityofnewyork.us/resource/833y-fsy8.json?$limit=500&$order=occur_date DESC"; // historical data is limited to 500

        fetch(nycApiUrl)
            .then(response => response.json())
            .then(data => {
                data.forEach(incident => {
                    if (incident.latitude && incident.longitude) {
                        const lat = parseFloat(incident.latitude);
                        const lng = parseFloat(incident.longitude);

                        nycHeatData.push([lat, lng, 1.0]);

                        const incidentId = incident.incident_key || `${incident.occur_date}-${lat}-${lng}`;
                        const marker = L.marker([incident.latitude, incident.longitude], { icon: redIcon });

                        const loadDiscussionPost = function () {
                            fetch(`/api/posts?latitude=${lat}&longitude=${lng}&radius=0.001`)
                                .then(response => response.json())
                                .then(posts => {
                                    const discussionPost = posts.find(p =>
                                        p.title && p.title.includes('NYC Shooting Incident') &&
                                        Math.abs(p.location.latitude - lat) < 0.0001 &&
                                        Math.abs(p.location.longitude - lng) < 0.0001
                                    );

                                    let discussionHtml = '';
                                    if (discussionPost) {
                                        fetch(`/api/posts/${discussionPost._id}/comments`)
                                            .then(response => response.json())
                                            .then(comments => {
                                                const currentUserId = '{{user._id}}';
                                                let commentsHtml = '';
                                                if (comments.length > 0) {
                                                    commentsHtml = '<div style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px;"><strong>Comments:</strong><ul style="margin:5px 0; padding-left:20px; max-height:100px; overflow-y:auto; font-size:12px;">';
                                                    comments.forEach(comment => {
                                                        const isOwner = comment.user === currentUserId;
                                                        const deleteBtn = isOwner ? `<button onclick="deleteMapComment('${discussionPost._id}', '${comment._id}', '${discussionPost._id}')" style="margin-left:5px; padding:2px 5px; font-size:10px; background:#dc3545; color:white; border:none; cursor:pointer; border-radius:3px;">Delete</button>` : '';
                                                        commentsHtml += `<li style="margin-bottom:3px;" id="comment-${comment._id}">${comment.text} <small>(Score: ${comment.score})</small> ${deleteBtn}</li>`;
                                                    });
                                                    commentsHtml += '</ul></div>';
                                                } else {
                                                    commentsHtml = '<div style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px;"><p style="font-style:italic; color:#666; font-size:12px;">No comments yet</p></div>';
                                                }

                                                const commentForm = `
                                                    <div style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px;">
                                                        <strong style="font-size:12px;">Add Comment:</strong>
                                                        <form id="comment-form-${discussionPost._id}" style="margin-top:5px;">
                                                            <textarea name="text" rows="2" placeholder="Write your comment..." required style="width:100%; padding:5px; box-sizing:border-box; font-size:11px;"></textarea>
                                                            <input type="number" name="score" min="0" max="5" value="3" required style="width:100%; padding:5px; margin-top:5px; box-sizing:border-box; font-size:11px;" placeholder="Score (0-5)">
                                                            <button type="submit" style="width:100%; margin-top:5px; padding:5px; background:#cb2b3e; color:white; border:none; cursor:pointer; font-size:11px;">Post Comment</button>
                                                        </form>
                                                    </div>
                                                `;

                                                const fullContent = `
                                                    <div class="incident-preview" style="max-width:300px;">
                                                        <h3 style="color: #d32f2f; margin:0 0 10px 0; font-size:16px;">NYC Shooting Incident</h3>
                                                        <p style="margin:3px 0; font-size:12px;"><strong>Date:</strong> ${incident.occur_date}</p>
                                                        <p style="margin:3px 0; font-size:12px;"><strong>Time:</strong> ${incident.occur_time}</p>
                                                        <p style="margin:3px 0; font-size:12px;"><strong>Boro:</strong> ${incident.boro}</p>
                                                        <p style="margin:3px 0; font-size:12px;"><strong>Location:</strong> ${incident.location_desc || 'Street'}</p>
                                                        <p style="margin:5px 0; font-size:10px; color:#666;"><small>Source: NYC Open Data</small></p>
                                                        <div style="margin-top:10px; padding-top:10px; border-top:1px solid #ccc;">
                                                            <p style="font-size:12px; margin:5px 0;"><strong>Community Discussion:</strong></p>
                                                            <a href="/posts/${discussionPost._id}" style="font-size:11px; color:#2b82cb;">View Full Discussion</a>
                                                        </div>
                                                        ${commentsHtml}
                                                        ${commentForm}
                                                    </div>
                                                `;

                                                marker.setPopupContent(fullContent);

                                                setTimeout(() => {
                                                    const form = document.getElementById(`comment-form-${discussionPost._id}`);
                                                    if (form) {
                                                        form.addEventListener('submit', function (e) {
                                                            e.preventDefault();
                                                            const formData = new FormData(e.target);
                                                            const text = formData.get('text');
                                                            const scoreStr = formData.get('score');
                                                            const score = parseInt(scoreStr);

                                                            if (!text || text.trim().length === 0) {
                                                                alert('Please enter a comment');
                                                                return;
                                                            }

                                                            if (isNaN(score) || score < 0 || score > 5) {
                                                                alert('Please enter a valid score between 0 and 5');
                                                                return;
                                                            }

                                                            fetch(`/api/posts/${discussionPost._id}/comments`, {
                                                                method: 'POST',
                                                                headers: {
                                                                    'Content-Type': 'application/json'
                                                                },
                                                                credentials: 'include',
                                                                body: JSON.stringify({
                                                                    text: text.trim(),
                                                                    score: score
                                                                })
                                                            })
                                                                .then(response => {
                                                                    console.log('NYC comment response status:', response.status);
                                                                    console.log('NYC comment response headers:', response.headers.get('content-type'));

                                                                    if (response.ok) {
                                                                        return response.json().then(data => {
                                                                            loadDiscussionPost();
                                                                        });
                                                                    } else {
                                                                        const contentType = response.headers.get('content-type');
                                                                        if (contentType && contentType.includes('application/json')) {
                                                                            return response.json().then(data => {
                                                                                alert('Error: ' + (data.error || 'Failed to post comment. Please make sure you are logged in.'));
                                                                            }).catch(() => {
                                                                                alert('Error: Failed to post comment. Please make sure you are logged in.');
                                                                            });
                                                                        } else {
                                                                            return response.text().then(text => {
                                                                                console.error('Non-JSON response:', text.substring(0, 200));
                                                                                alert('Error: Server returned non-JSON response. Status: ' + response.status + '. Please check console for details.');
                                                                            });
                                                                        }
                                                                    }
                                                                })
                                                                .catch(err => {
                                                                    alert('Error posting comment: ' + err.message);
                                                                    console.error(err);
                                                                });
                                                        });
                                                    }
                                                }, 100);
                                            })
                                            .catch(err => console.error("Error loading comments:", err));
                                    } else {
                                        const createDiscussionForm = `
                                            <div style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px;">
                                                <p style="font-size:12px; margin:5px 0;"><strong>Start Discussion:</strong></p>
                                                <form id="create-discussion-${incidentId}" style="margin-top:5px;">
                                                    <textarea name="comment" rows="2" placeholder="Add your comment or context..." required style="width:100%; padding:5px; box-sizing:border-box; font-size:11px;"></textarea>
                                                    <input type="number" name="score" min="0" max="5" value="3" required style="width:100%; padding:5px; margin-top:5px; box-sizing:border-box; font-size:11px;" placeholder="Score (0-5)">
                                                    <button type="submit" style="width:100%; margin-top:5px; padding:5px; background:#cb2b3e; color:white; border:none; cursor:pointer; font-size:11px;">Create Discussion & Comment</button>
                                                </form>
                                            </div>
                                        `;

                                        const fullContent = `
                                            <div class="incident-preview" style="max-width:300px;">
                                                <h3 style="color: #d32f2f; margin:0 0 10px 0; font-size:16px;">NYC Shooting Incident</h3>
                                                <p style="margin:3px 0; font-size:12px;"><strong>Date:</strong> ${incident.occur_date}</p>
                                                <p style="margin:3px 0; font-size:12px;"><strong>Time:</strong> ${incident.occur_time}</p>
                                                <p style="margin:3px 0; font-size:12px;"><strong>Boro:</strong> ${incident.boro}</p>
                                                <p style="margin:3px 0; font-size:12px;"><strong>Location:</strong> ${incident.location_desc || 'Street'}</p>
                                                <p style="margin:5px 0; font-size:10px; color:#666;"><small>Source: NYC Open Data</small></p>
                                                ${createDiscussionForm}
                                            </div>
                                        `;

                                        marker.setPopupContent(fullContent);

                                        setTimeout(() => {
                                            const form = document.getElementById(`create-discussion-${incidentId}`);
                                            if (form) {
                                                form.addEventListener('submit', function (e) {
                                                    e.preventDefault();
                                                    const formData = new FormData(e.target);
                                                    const comment = formData.get('comment');
                                                    const scoreStr = formData.get('score');
                                                    const score = parseInt(scoreStr);

                                                    if (!comment || comment.trim().length === 0) {
                                                        alert('Please enter a comment');
                                                        return;
                                                    }

                                                    if (isNaN(score) || score < 0 || score > 5) {
                                                        alert('Please enter a valid score between 0 and 5');
                                                        return;
                                                    }

                                                    const title = `NYC Shooting Incident - ${incident.occur_date} - ${incident.boro}`;
                                                    const body = `Official NYC Shooting Incident\n\nDate: ${incident.occur_date}\nTime: ${incident.occur_time}\nBorough: ${incident.boro}\nLocation: ${incident.location_desc || 'Street'}\n\nCommunity Comment: ${comment.trim()}`;

                                                    fetch('/api/posts', {
                                                        method: 'POST',
                                                        headers: {
                                                            'Content-Type': 'application/json'
                                                        },
                                                        credentials: 'include',
                                                        body: JSON.stringify({
                                                            title: title,
                                                            body: body,
                                                            location: {
                                                                latitude: lat,
                                                                longitude: lng
                                                            },
                                                            photo: null,
                                                            sensitive: false
                                                        })
                                                    })
                                                        .then(response => {
                                                            const contentType = response.headers.get('content-type');
                                                            if (response.ok) {
                                                                if (contentType && contentType.includes('application/json')) {
                                                                    return response.json();
                                                                } else {
                                                                    throw new Error('Server returned non-JSON response');
                                                                }
                                                            } else {
                                                                if (contentType && contentType.includes('application/json')) {
                                                                    return response.json().then(data => {
                                                                        throw new Error(data.error || 'Failed to create discussion. Please make sure you are logged in.');
                                                                    });
                                                                } else {
                                                                    throw new Error('Failed to create discussion. Please make sure you are logged in.');
                                                                }
                                                            }
                                                        })
                                                        .then(post => {
                                                            console.log('Created discussion post:', post);
                                                            console.log('Posting comment to post ID:', post._id);
                                                            const commentUrl = `/api/posts/${post._id}/comments`;
                                                            console.log('Comment URL:', commentUrl);
                                                            return fetch(commentUrl, {
                                                                method: 'POST',
                                                                headers: {
                                                                    'Content-Type': 'application/json'
                                                                },
                                                                credentials: 'include',
                                                                body: JSON.stringify({
                                                                    text: comment.trim(),
                                                                    score: score
                                                                })
                                                            });
                                                        })
                                                        .then(response => {
                                                            console.log('Create discussion comment response status:', response.status);
                                                            console.log('Create discussion comment response URL:', response.url);
                                                            console.log('Create discussion comment response headers:', response.headers.get('content-type'));
                                                            console.log('Create discussion comment redirected:', response.redirected);

                                                            if (response.ok) {
                                                                const contentType = response.headers.get('content-type');
                                                                if (contentType && contentType.includes('application/json')) {
                                                                    return response.json().then(data => {
                                                                        marker.closePopup();
                                                                        setTimeout(() => {
                                                                            marker.openPopup();
                                                                            loadDiscussionPost();
                                                                        }, 100);
                                                                    });
                                                                } else {
                                                                    return response.text().then(text => {
                                                                        console.error('Non-JSON response (OK):', text.substring(0, 500));
                                                                        throw new Error('Server returned non-JSON response');
                                                                    });
                                                                }
                                                            } else {
                                                                const contentType = response.headers.get('content-type');
                                                                if (contentType && contentType.includes('application/json')) {
                                                                    return response.json().then(data => {
                                                                        alert('Error: ' + (data.error || 'Failed to post comment. Please make sure you are logged in.'));
                                                                    }).catch(() => {
                                                                        alert('Error: Failed to post comment. Please make sure you are logged in.');
                                                                    });
                                                                } else {
                                                                    return response.text().then(text => {
                                                                        console.error('Non-JSON response (Error):', text.substring(0, 500));
                                                                        console.error('Response status:', response.status);
                                                                        console.error('Response URL:', response.url);
                                                                        alert('Error: Server returned non-JSON response. Status: ' + response.status + '. Check console for details.');
                                                                    });
                                                                }
                                                            }
                                                        })
                                                        .catch(err => {
                                                            alert('Error: ' + err.message);
                                                            console.error(err);
                                                        });
                                                });
                                            }
                                        }, 100);
                                    }
                                })
                                .catch(err => console.error("Error loading discussion:", err));
                        };

                        marker.on('popupopen', function () {
                            loadDiscussionPost();
                        });

                        const initialContent = `
                            <div class="incident-preview" style="max-width:300px;">
                                <h3 style="color: #d32f2f; margin:0 0 10px 0; font-size:16px;">NYC Shooting Incident</h3>
                                <p style="margin:3px 0; font-size:12px;"><strong>Date:</strong> ${incident.occur_date}</p>
                                <p style="margin:3px 0; font-size:12px;"><strong>Time:</strong> ${incident.occur_time}</p>
                                <p style="margin:3px 0; font-size:12px;"><strong>Boro:</strong> ${incident.boro}</p>
                                <p style="margin:3px 0; font-size:12px;"><strong>Location:</strong> ${incident.location_desc || 'Street'}</p>
                                <p style="margin:5px 0; font-size:10px; color:#666;"><small>Source: NYC Open Data</small></p>
                                <p style="font-style:italic; color:#666; font-size:12px; margin-top:10px;">Loading discussion...</p>
                            </div>
                        `;

                        marker.bindPopup(initialContent, { maxWidth: 350 }).addTo(nycMarkers);
                    }
                });
                updateHeatmap();
            })
            .catch(err => console.error("Error loading NYC data:", err));

        // Click event to create a new Post
        map.on('click', function (e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            // Check bounds (Double check client side)
            if (lat < 40.496 || lat > 40.916 || lng < -74.258 || lng > -73.699) {
                alert("Location is outside of NYC.");
                return;
            }

            const popupContent = `
                <div class="popup-form">
                    <h3>Report Incident Here</h3>
                    <form action="/api/posts" method="POST">
                        <input type="hidden" name="latitude" value="${lat}">
                        <input type="hidden" name="longitude" value="${lng}">
                        
                        <label>Title:</label>
                        <input type="text" name="title" required placeholder="Short title...">
                        
                        <label>Description:</label>
                        <textarea name="body" rows="3" placeholder="What happened?"></textarea>
                        
                        <label>Photo URL (Optional):</label>
                        <input type="text" name="photo" placeholder="http://...">
                        
                        <label>
                            <input type="checkbox" name="sensitive"> 
                            Contains Sensitive Content?
                        </label>
                        
                        <button type="submit" class="button-primary" style="width:100%; margin-top:5px;">Create Post</button>
                    </form>
                </div>
            `;

            L.popup()
                .setLatLng(e.latlng)
                .setContent(popupContent)
                .openOn(map);
        });
        document.getElementById('toggleHeatmap').addEventListener('change', function () {
            updateHeatmap();

            // Auto interaction: If Heatmap ON, turn Markers OFF for clarity
            const markersToggle = document.getElementById('toggleMarkers');
            if (this.checked && markersToggle.checked) {
                markersToggle.checked = false;
                markersToggle.dispatchEvent(new Event('change')); // Trigger marker logic
            }
        });

        document.getElementById('toggleMarkers').addEventListener('change', function () {
            if (this.checked) {
                // If Markers turned ON, maybe turn Heatmap OFF? (Optional, let's keep it flexible or do the reverse)
                // For now, just show the layers
                if (document.getElementById('toggleCommunity').checked) {
                    map.addLayer(communityMarkers);
                }
                if (document.getElementById('toggleNYC').checked) {
                    map.addLayer(nycMarkers);
                }
            } else {
                map.removeLayer(communityMarkers);
                map.removeLayer(nycMarkers);
            }
        });

        document.getElementById('toggleCommunity').addEventListener('change', function () {
            if (this.checked && document.getElementById('toggleMarkers').checked) {
                map.addLayer(communityMarkers);
            } else {
                map.removeLayer(communityMarkers);
            }
            updateHeatmap();
        });

        document.getElementById('toggleNYC').addEventListener('change', function () {
            if (this.checked && document.getElementById('toggleMarkers').checked) {
                map.addLayer(nycMarkers);
            } else {
                map.removeLayer(nycMarkers);
            }
            updateHeatmap();
        });

        document.getElementById('heatRadius').addEventListener('input', function () {
            heatConfig.radius = parseInt(this.value);
            document.getElementById('radiusValue').textContent = this.value;
            updateHeatmap();
        });

        document.getElementById('heatIntensity').addEventListener('input', function () {
            heatConfig.max = parseFloat(this.value);
            document.getElementById('intensityValue').textContent = this.value;
            updateHeatmap();
        });

        // Add Legend
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <strong>Legend</strong><br>
                <i style="background: #2b82cb"></i> Community Posts<br>
                <i style="background: #cb2b3e"></i> NYC Shooting Data<br>
                <br>
                <strong>Heatmap Intensity</strong>
                <div class="heatmap-gradient"></div>
                <div class="gradient-labels">
                    <span>Low</span>
                    <span>High</span>
                </div>
            `;
            return div;
        };
        legend.addTo(map);
    });

    function deleteMapComment(postId, commentId, refreshPostId) {
        if (!confirm('Are you sure you want to delete this comment?')) {
            return;
        }
        
        fetch(`/api/posts/${postId}/comments/${commentId}`, {
            method: 'DELETE',
            credentials: 'include'
        })
        .then(response => {
            if (response.ok) {
                const commentElement = document.getElementById(`comment-${commentId}`);
                if (commentElement) {
                    commentElement.remove();
                }
                if (window.map) {
                    const allMarkers = [];
                    window.map.eachLayer(layer => {
                        if (layer instanceof L.Marker && layer.isPopupOpen()) {
                            allMarkers.push(layer);
                        }
                    });
                    if (allMarkers.length > 0) {
                        const openMarker = allMarkers[0];
                        openMarker.fire('popupopen');
                    }
                }
            } else {
                return response.json().then(data => {
                    alert('Error: ' + (data.error || 'Failed to delete comment'));
                });
            }
        })
        .catch(err => {
            alert('Error deleting comment: ' + err.message);
            console.error(err);
        });
    }
</script>