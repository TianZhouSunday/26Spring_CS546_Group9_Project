{{!-- frontendstuff/views/map.handlebars --}}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- plugin for heatmap (leaflet)-->
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>



<div id="map-container">
    <div id="map"></div>
    <script src="/public/js/map-helpers.js"></script>
    <script>
        // Initialize Global Config for Helpers
        window.MapConfig = {
            currentUserId: '{{user._id}}'
        };
    </script>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <label>
            <strong>Filter:</strong>
        </label>
        <label>
            Borough:
            <select id="filterBorough" style="padding: 2px;">
                <option value="All">All</option>
                <option value="Manhattan">Manhattan</option>
                <option value="Brooklyn">Brooklyn</option>
                <option value="Queens">Queens</option>
                <option value="The Bronx">The Bronx</option>
                <option value="Staten Island">Staten Island</option>
            </select>
        </label>
        <label>
            Min Score: <span id="minScoreVal">0</span>
            <input type="range" id="filterMinScore" min="0" max="5" step="0.5" value="0"
                style="width: 100px; margin-left: 5px;">
        </label>
    </div>

    <!-- Map Controls Moved Inside Container -->
    <div class="map-controls">
        <h4 style="margin: 0 0 10px 0; font-size: 1rem;">Map Layers</h4>
        <label>
            <input type="checkbox" id="toggleMarkers" checked>
            View Crime Markers
        </label>
        <label>
            <input type="checkbox" id="toggleCommunity" checked>
            Data: Community
        </label>
        <label>
            <input type="checkbox" id="toggleNYC" checked>
            Data: NYC Official
        </label>

        <hr style="width: 100%; border: 0; border-top: 1px solid #eee; margin: 5px 0;">

        <h4 style="margin: 0 0 10px 0; font-size: 1rem;">Heatmap Settings</h4>
        <label>
            <input type="checkbox" id="toggleHeatmap">
            Display Heatmap
        </label>
        <div class="slider-container">
            <div style="margin-bottom: 5px;">Radius: <span id="radiusValue">25</span></div>
            <input type="range" id="heatRadius" min="10" max="60" value="25" style="width: 100%">
        </div>
        <div class="slider-container">
            <div style="margin-bottom: 5px;">Intensity: <span id="intensityValue">0.5</span></div>
            <input type="range" id="heatIntensity" min="0.1" max="1.5" step="0.1" value="0.5" style="width: 100%">
        </div>
    </div>
</div>

<script src="/public/js/map-init.js"></script>

<script>
function deleteMapComment(postId, commentId, refreshPostId) {
    if (!confirm('Are you sure you want to delete this comment?')) {
        return;
    }

    fetch(`/api/posts/${postId}/comments/${commentId}`, {
        method: 'DELETE',
        credentials: 'include'
    })
    .then(response => {
        if (response.ok) {
            const commentElement = document.getElementById(`comment-${commentId}`);
            if (commentElement) {
                commentElement.remove();
            }
            if (window.map) {
                const allMarkers = [];
                window.map.eachLayer(layer => {
                    if (layer instanceof L.Marker && layer.isPopupOpen()) {
                        allMarkers.push(layer);
                    }
                });
                if (allMarkers.length > 0) {
                    const openMarker = allMarkers[0];
                    openMarker.fire('popupopen');
                }
            }
        } else {
            return response.json().then(data => {
                alert('Error: ' + (data.error || 'Failed to delete comment'));
            });
        }
    })
    .catch(err => {
        alert('Error deleting comment: ' + err.message);
        console.error(err);
    });
}

window.ratePost = function (postId, rating, refreshPostId) {
    const avgRatingElement = document.getElementById(`map-avg-rating-${refreshPostId || postId}`);
    if (!avgRatingElement) {
        console.error('Rating element not found:', `map-avg-rating-${refreshPostId || postId}`);
    }

    return fetch(`/api/posts/${postId}/rate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({ rating: rating })
    })
    .then(response => {
        if (response.ok) {
            return response.json().then(data => {
                if (avgRatingElement) {
                    avgRatingElement.textContent = data.averageRating.toFixed(1);
                } else {
                    const retryElement = document.getElementById(`map-avg-rating-${refreshPostId || postId}`);
                    if (retryElement) {
                        retryElement.textContent = data.averageRating.toFixed(1);
                    }
                }
                return data;
            });
        } else {
            return response.json().then(data => {
                throw new Error(data.error || 'Failed to rate post');
            });
        }
    })
    .catch(err => {
        alert('Error rating post: ' + err.message);
        console.error(err);
        throw err;
    });
};

window.rateNYCIncident = function (incidentId, rating, lat, lng, occurDate, boro, occurTime, locationDesc) {
    return fetch(`/api/posts?latitude=${lat}&longitude=${lng}&radius=0.001`, { credentials: 'include' })
        .then(response => response.json())
        .then(posts => {
            let discussionPost = posts.find(p =>
                p.title && p.title.includes('NYC Shooting Incident') &&
                Math.abs(p.location.latitude - lat) < 0.0001 &&
                Math.abs(p.location.longitude - lng) < 0.0001
            );

            if (!discussionPost) {
                const title = `NYC Shooting Incident - ${occurDate} - ${boro}`;
                const body = `Official NYC Shooting Incident\n\nDate: ${occurDate}\nTime: ${occurTime}\nBorough: ${boro}\nLocation: ${locationDesc}`;
                return fetch('/api/posts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        title: title,
                        body: body,
                        location: { latitude: lat, longitude: lng },
                        photo: null,
                        sensitive: false
                    })
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return response.json().then(data => {
                            throw new Error(data.error || 'Failed to create discussion');
                        });
                    }
                })
                .then(post => {
                    discussionPost = post;
                    return window.ratePost(post._id, rating, post._id).then(() => {
                        if (window.map) {
                            window.map.eachLayer(layer => {
                                if (layer instanceof L.Marker && layer.isPopupOpen()) {
                                    const popupContent = layer.getPopup().getContent();
                                    if (popupContent && popupContent.includes(incidentId)) {
                                        layer.fire('popupopen');
                                    }
                                }
                            });
                        }
                    });
                });
            } else {
                return window.ratePost(discussionPost._id, rating, discussionPost._id);
            }
        })
        .catch(err => {
            alert('Error rating incident: ' + err.message);
            console.error(err);
            throw err;
        });
};
</script>