<div class="post-detail">
    <article class="post-details {{#if post.sensitive}}sensitive{{/if}}">
        <div class="post-header">
            <h1>{{post.title}}</h1>
            {{#if post.sensitive}}
            <span class="sensitive-badge">Warning: Sensitive Content</span>
            {{/if}}
        </div>

        <div class="post-info">
            <!-- strong used for easy bolding/importance -->
            <p><strong>Posted:</strong> {{post.date}}</p>
            <p><strong>Location:</strong> {{post.location.latitude}}, {{post.location.longitude}}</p>
            <p><strong>Score:</strong> {{post.post_score}}</p>
            {{#if post.anonymous}}
                <p><strong>Posted Anonymously</strong>
            {{else}}
                <p><strong>Posted by:</strong><a href="/user/{{post.user}}">{{user.username}}</a>
            {{/if}}
            </p>
        </div>

        {{#if (and post.sensitive currentUser.hideSensitiveContent)}}
        <details class="sensitive-content-container">
            <summary class="sensitive-warning">
                ⚠️ This post contains sensitive content (Click to view)
            </summary>

            {{#if post.photo}}
            <div class="post-photo">
                <img src="{{post.photo}}" alt="{{post.title}}">
            </div>
            {{/if}}

            {{#if post.body}}
            <div class="post-content">
                <h2>Description</h2>
                <p>{{post.body}}</p>
            </div>
            {{/if}}
        </details>
        {{else}}
        {{#if post.photo}}
        <div class="post-photo">
            <img src="{{post.photo}}" alt="{{post.title}}">
        </div>
        {{/if}}

        {{#if post.body}}
        <div class="post-content">
            <h2>Description</h2>
            <p>{{post.body}}</p>
        </div>
        {{/if}}
        {{/if}}

        <div class="post-actions">
            <a href="/posts" class="button">Back to Posts</a>

            {{#if (eq post.user currentUser._id)}}
            <form method="POST" action="/posts/{{post._id}}/delete" class="inline-form">
                <button type="submit" class="button-danger"
                    onclick="return confirm('Are you sure you want to delete this post?')">
                    Delete Post
                </button>
            </form>
            {{/if}}
        </div>

        <div class="rating-section" style="margin:20px 0; padding:20px; background:#f8f9fa; border:2px solid #2b82cb; border-radius:8px;">
            <h3 style="margin:0 0 10px 0; color:#2b82cb;">Rate This Incident</h3>
            <p style="margin:5px 0; font-size:16px;">Usefulness Rating: <strong style="font-size:18px; color:#2b82cb;">{{#if post.post_score}}{{post.post_score.toFixed}}{{else}}0{{/if}}</strong>/5.0</p>
            <p style="margin:10px 0 15px 0; color:#666; font-size:14px;">How useful is this incident report?</p>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="ratePostPage('{{post._id}}', 1)" class="button" style="flex:1; padding:12px; font-size:16px; font-weight:bold; background:#fff; border:2px solid #2b82cb; color:#2b82cb; border-radius:5px; cursor:pointer;">1</button>
                <button onclick="ratePostPage('{{post._id}}', 2)" class="button" style="flex:1; padding:12px; font-size:16px; font-weight:bold; background:#fff; border:2px solid #2b82cb; color:#2b82cb; border-radius:5px; cursor:pointer;">2</button>
                <button onclick="ratePostPage('{{post._id}}', 3)" class="button" style="flex:1; padding:12px; font-size:16px; font-weight:bold; background:#fff; border:2px solid #2b82cb; color:#2b82cb; border-radius:5px; cursor:pointer;">3</button>
                <button onclick="ratePostPage('{{post._id}}', 4)" class="button" style="flex:1; padding:12px; font-size:16px; font-weight:bold; background:#fff; border:2px solid #2b82cb; color:#2b82cb; border-radius:5px; cursor:pointer;">4</button>
                <button onclick="ratePostPage('{{post._id}}', 5)" class="button" style="flex:1; padding:12px; font-size:16px; font-weight:bold; background:#fff; border:2px solid #2b82cb; color:#2b82cb; border-radius:5px; cursor:pointer;">5</button>
            </div>
        </div>

        {{#if post.comments.length}}
        <div class="comments-section">
            <h2>Comments ({{comments.length}})</h2>

            {{#each comments}}
            <div class="comment" id="comment-{{this._id}}">
                <p class="comment-text">{{this.text}}</p>
                <p class="comment-meta">Score: {{this.score}}</p>

                {{#if (eq this.user ../currentUser._id.toString)}}
                <button type="button" class="button-danger delete-comment-btn" 
                    data-comment-id="{{this._id}}" 
                    data-post-id="{{../post._id}}"
                    onclick="if(confirm('Are you sure you want to delete this comment?')) deleteComment('{{this._id}}', '{{../post._id}}')">
                    Delete
                </button>
                {{/if}}
            </div>
            {{/each}}
        </div>
        {{/if}}

        <div class="add-comment-section">
            <h3>Add a Comment</h3>
            <form method="POST" action="/posts/{{post._id}}/comment">
                <div class="form-group">
                    <textarea name="text" rows="3" placeholder="Write your comment..." required></textarea>
                </div>
                <button type="submit" class="button-primary">Post Comment</button>
            </form>
        </div>
    </article>
</div>

<script>
function deleteComment(commentId, postId) {
    fetch(`/api/posts/${postId}/comments/${commentId}`, {
        method: 'DELETE',
        credentials: 'include'
    })
    .then(response => {
        if (response.ok) {
            const commentElement = document.getElementById(`comment-${commentId}`);
            if (commentElement) {
                commentElement.remove();
                const commentsSection = document.querySelector('.comments-section h2');
                if (commentsSection) {
                    const currentCount = parseInt(commentsSection.textContent.match(/\d+/)[0]);
                    commentsSection.textContent = `Comments (${currentCount - 1})`;
                }
            }
        } else {
            return response.json().then(data => {
                alert('Error: ' + (data.error || 'Failed to delete comment'));
            });
        }
    })
    .catch(err => {
        alert('Error deleting comment: ' + err.message);
        console.error(err);
    });
}

function ratePostPage(postId, rating) {
    fetch(`/api/posts/${postId}/rate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({ rating: rating })
    })
    .then(response => {
        if (response.ok) {
            return response.json().then(data => {
                const ratingSection = document.querySelector('.rating-section p');
                if (ratingSection) {
                    ratingSection.innerHTML = `Current Rating: <strong>${data.averageRating.toFixed(1)}</strong>/5.0`;
                }
            });
        } else {
            return response.json().then(data => {
                alert('Error: ' + (data.error || 'Failed to rate post'));
            });
        }
    })
    .catch(err => {
        alert('Error rating post: ' + err.message);
        console.error(err);
    });
}
</script>